blueprint:
  name: "üî• D√©tecteur de Fum√©e Intelligent & S√©curit√© Incendie"
  description: |
    Blueprint avanc√© pour la gestion des d√©tecteurs de fum√©e avec syst√®me d'√©vacuation d'urgence,
    notifications critiques, actions automatiques et protocoles de s√©curit√© complets.
    
    Fonctionnalit√©s principales:
    - Notifications critiques imm√©diates multi-canaux
    - Notifications r√©p√©t√©es toutes les 2 minutes avec escalade
    - Protocole d'√©vacuation automatique intelligent
    - Actions d'urgence coordonn√©es (lumi√®res, sir√®nes, ouvertures)
    - Notifications de localisation pr√©cise
    - Mode test et maintenance
    - Int√©gration services d'urgence
    - Surveillance batterie et √©tat des d√©tecteurs
    - Notifications m√©t√©o critiques (canicule, orages)
    - Syst√®me de liaison entre d√©tecteurs
    - Enregistrement des incidents
    
  domain: automation
  
  input:
    # === D√âTECTEURS DE FUM√âE ===
    smoke_detectors:
      name: "üö® D√©tecteurs de fum√©e"
      description: "S√©lectionnez tous vos d√©tecteurs de fum√©e"
      selector:
        entity:
          filter:
            - device_class: smoke
          multiple: true
    
    co_detectors:
      name: "‚ò†Ô∏è D√©tecteurs de monoxyde de carbone (optionnel)"
      description: "D√©tecteurs de CO √† inclure dans le syst√®me d'alarme"
      default: []
      selector:
        entity:
          filter:
            - device_class: gas
            - device_class: co
          multiple: true
    
    # === SERVICES DE NOTIFICATION ===
    notification_services:
      name: "üì± Services de notification d'urgence"
      description: "Tous les canaux de notification √† utiliser"
      selector:
        select:
          options:
            - label: "üì± Application mobile"
              value: "mobile_app"
            - label: "üìß Email"
              value: "email"
            - label: "üì≤ Telegram"
              value: "telegram"
            - label: "üí¨ Discord"
              value: "discord"
            - label: "üîî Slack"
              value: "slack"
            - label: "üìÆ Pushbullet"
              value: "pushbullet"
            - label: "üè† Notification persistante HA"
              value: "persistent"
            - label: "üìª Appel t√©l√©phonique (SIP)"
              value: "sip_call"
          multiple: true
          custom_value: true
      default: ["mobile_app", "email", "persistent"]
    
    mobile_devices:
      name: "üì≤ Appareils mobiles d'urgence"
      description: "Tous les t√©l√©phones √† alerter en priorit√©"
      default: []
      selector:
        device:
          filter:
            - integration: mobile_app
          multiple: true
    
    emergency_contacts:
      name: "üÜò Contacts d'urgence"
      description: "Emails/t√©l√©phones de vos contacts d'urgence (s√©par√©s par des virgules)"
      default: ""
      selector:
        text:
          multiline: true
    
    # === MESSAGES PERSONNALIS√âS ===
    fire_alert_title:
      name: "üî• Titre alerte incendie"
      description: "Titre pour l'alerte de d√©tection de fum√©e/feu"
      default: "üö® ALERTE INCENDIE - √âVACUATION IMM√âDIATE"
      selector:
        text: {}
    
    fire_alert_message:
      name: "üî• Message alerte incendie"
      description: "Message d√©taill√© de l'alerte incendie"
      default: |
        üî• INCENDIE D√âTECT√â - √âVACUATION IMM√âDIATE !
        
        üìç D√©tecteur: {{ trigger.to_state.attributes.friendly_name }}
        üè† Zone: {{ area_name(trigger.entity_id) or 'Zone inconnue' }}
        üïí Heure: {{ now().strftime('%d/%m/%Y √† %H:%M:%S') }}
        üå°Ô∏è Temp√©rature: {{ states('sensor.temperature_' + area_name(trigger.entity_id).lower()) or 'N/A' }}¬∞C
        
        ‚ö†Ô∏è SORTEZ IMM√âDIATEMENT DU B√ÇTIMENT
        üìû Appelez les pompiers: 18 ou 112
        üö™ Point de rassemblement: [√Ä d√©finir]
        
        üî¥ Ne prenez pas l'ascenseur
        üî¥ Fermez les portes derri√®re vous
        üî¥ Si la fum√©e est dense, restez au sol
      selector:
        text:
          type: text
          multiline: true
    
    repeat_message:
      name: "üîÑ Message de rappel d'urgence"
      description: "Message pour notifications r√©p√©t√©es"
      default: |
        üö® RAPPEL URGENT - INCENDIE TOUJOURS ACTIF !
        
        üìç {{ trigger.to_state.attributes.friendly_name }}
        ‚è∞ Alerte depuis {{ (now() - trigger.to_state.last_changed).total_seconds() // 60 }} minutes
        üîî Rappel #{{ repeat.index }}
        
        ‚ö†Ô∏è SI VOUS √äTES ENCORE DANS LE B√ÇTIMENT :
        üèÉ √âVACUEZ IMM√âDIATEMENT !
        üìû APPELEZ LES POMPIERS : 18 ou 112
        
        üÜò Ce message se r√©p√®te toutes les 2 minutes
      selector:
        text:
          type: text
          multiline: true
    
    co_alert_message:
      name: "‚ò†Ô∏è Message alerte monoxyde de carbone"
      description: "Message sp√©cifique pour le CO"
      default: |
        ‚ò†Ô∏è DANGER - MONOXYDE DE CARBONE D√âTECT√â !
        
        üìç D√©tecteur: {{ trigger.to_state.attributes.friendly_name }}
        üè† Zone: {{ area_name(trigger.entity_id) or 'Zone inconnue' }}
        üïí Heure: {{ now().strftime('%d/%m/%Y √† %H:%M:%S') }}
        
        ‚ö†Ô∏è ACTIONS IMM√âDIATES REQUISES :
        üö™ Ouvrez toutes les fen√™tres et portes
        üèÉ Sortez imm√©diatement √† l'air libre
        üö´ N'utilisez aucun appareil √©lectrique
        üìû Appelez les pompiers: 18 ou 112
        
        ‚ò†Ô∏è Le CO est invisible et mortel !
      selector:
        text:
          type: text
          multiline: true
    
    resolved_message:
      name: "‚úÖ Message de r√©solution"
      description: "Message envoy√© quand l'alerte est r√©solue"
      default: |
        ‚úÖ Alerte incendie r√©solue
        
        üìç {{ trigger.to_state.attributes.friendly_name }}
        ‚è±Ô∏è Dur√©e de l'incident: {{ (now() - trigger.to_state.last_changed).total_seconds() // 60 }} minutes
        üïí R√©solu le: {{ now().strftime('%d/%m/%Y √† %H:%M:%S') }}
        
        ‚ö†Ô∏è V√âRIFICATIONS RECOMMAND√âES :
        üîç Inspectez la zone pour des d√©g√¢ts
        üè† A√©rez compl√®tement avant de r√©int√©grer
        üîß V√©rifiez le d√©tecteur de fum√©e
        üìû Contactez votre assurance si n√©cessaire
      selector:
        text:
          type: text
          multiline: true
    
    # === PARAM√àTRES D'URGENCE ===
    repeat_interval:
      name: "‚è±Ô∏è Intervalle des rappels d'urgence"
      description: "Fr√©quence des notifications r√©p√©t√©es"
      default: 2
      selector:
        number:
          min: 1
          max: 5
          step: 1
          unit_of_measurement: "minutes"
    
    max_notifications:
      name: "üî¢ Limite de notifications"
      description: "Nombre maximum de rappels (0 = illimit√©)"
      default: 0
      selector:
        number:
          min: 0
          max: 50
          step: 1
    
    escalation_enabled:
      name: "üìà Escalade d'urgence"
      description: "Acc√©l√©rer les notifications apr√®s un d√©lai"
      default: true
      selector:
        boolean: {}
    
    escalation_time:
      name: "‚è∞ D√©lai avant escalade"
      description: "Temps avant acc√©l√©ration des alertes"
      default: 5
      selector:
        number:
          min: 2
          max: 15
          step: 1
          unit_of_measurement: "minutes"
    
    # === ACTIONS D'√âVACUATION AUTOMATIQUES ===
    emergency_actions:
      name: "üÜò Actions d'√©vacuation automatiques"
      description: "Actions d√©clench√©es automatiquement en cas d'incendie"
      default: ["emergency_lighting", "siren", "door_unlock", "window_open"]
      selector:
        select:
          options:
            - label: "üí° √âclairage d'√©vacuation maximal"
              value: "emergency_lighting"
            - label: "üö® Sir√®nes d'alarme"
              value: "siren"
            - label: "üö™ D√©verrouillage des porties"
              value: "door_unlock"
            - label: "ü™ü Ouverture automatique des fen√™tres"
              value: "window_open"
            - label: "üö∞ Coupure gaz et √©lectricit√©"
              value: "utilities_shutdown"
            - label: "üìπ Enregistrement cam√©ras de s√©curit√©"
              value: "camera_record"
            - label: "üì¢ Annonces TTS d'√©vacuation"
              value: "tts_evacuation"
            - label: "üîî Liaison d√©tecteurs (tous sonnent)"
              value: "detectors_linkage"
            - label: "‚ùÑÔ∏è Arr√™t climatisation/chauffage"
              value: "hvac_shutdown"
          multiple: true
    
    # === √âQUIPEMENTS D'URGENCE ===
    emergency_lights:
      name: "üí° √âclairage d'√©vacuation"
      description: "Lumi√®res √† allumer au maximum pour l'√©vacuation"
      default: []
      selector:
        entity:
          filter:
            - domain: light
          multiple: true
    
    emergency_sirens:
      name: "üö® Sir√®nes d'alarme"
      description: "Sir√®nes et alarmes sonores √† activer"
      default: []
      selector:
        entity:
          filter:
            - domain: siren
            - domain: switch
          multiple: true
    
    smart_locks:
      name: "üö™ Serrures intelligentes"
      description: "Serrures √† d√©verrouiller automatiquement"
      default: []
      selector:
        entity:
          filter:
            - domain: lock
          multiple: true
    
    smart_windows:
      name: "ü™ü Fen√™tres/volets motoris√©s"
      description: "Fen√™tres/volets √† ouvrir pour l'a√©ration"
      default: []
      selector:
        entity:
          filter:
            - domain: cover
          multiple: true
    
    gas_valve:
      name: "‚õΩ Vanne de gaz principale"
      description: "Vanne de gaz √† fermer automatiquement"
      default: {}
      selector:
        entity:
          filter:
            - domain: switch
            - domain: valve
          multiple: false
    
    main_breaker:
      name: "‚ö° Disjoncteur principal"
      description: "Disjoncteur √† couper (sauf √©clairage d'urgence)"
      default: {}
      selector:
        entity:
          filter:
            - domain: switch
          multiple: false
    
    hvac_system:
      name: "‚ùÑÔ∏è Syst√®me CVC"
      description: "Climatisation/chauffage √† arr√™ter"
      default: []
      selector:
        entity:
          filter:
            - domain: climate
          multiple: true
    
    security_cameras:
      name: "üìπ Cam√©ras de s√©curit√©"
      description: "Cam√©ras pour enregistrement d'urgence"
      default: []
      selector:
        entity:
          filter:
            - domain: camera
          multiple: true
    
    tts_speakers:
      name: "üì¢ Haut-parleurs pour annonces"
      description: "Enceintes pour annonces d'√©vacuation"
      default: []
      selector:
        entity:
          filter:
            - domain: media_player
          multiple: true
    
    # === SURVEILLANCE AVANC√âE ===
    monitor_battery:
      name: "üîã Surveillance batterie des d√©tecteurs"
      description: "Alerter si batterie faible"
      default: true
      selector:
        boolean: {}
    
    battery_threshold:
      name: "üîã Seuil batterie critique"
      description: "Pourcentage batterie pour alerte"
      default: 20
      selector:
        number:
          min: 10
          max: 50
          step: 5
          unit_of_measurement: "%"
    
    test_mode_entity:
      name: "üß™ Input Boolean mode test"
      description: "Bouton pour mode test (ne d√©clenche pas l'√©vacuation)"
      default: {}
      selector:
        entity:
          filter:
            - domain: input_boolean
          multiple: false
    
    # === INT√âGRATIONS EXTERNES ===
    weather_warnings:
      name: "üå™Ô∏è Alertes m√©t√©o extr√™me"
      description: "Inclure alertes canicule/orages dans surveillance"
      default: false
      selector:
        boolean: {}
    
    emergency_services_notification:
      name: "üö® Notification services d'urgence"
      description: "Envoyer notification aux services d'urgence (email/SMS)"
      default: false
      selector:
        boolean: {}
    
    # === PARAM√àTRES NOTIFICATION ===
    critical_priority:
      name: "üî¥ Priorit√© critique"
      description: "Utiliser notifications critiques (contournent mode silencieux)"
      default: true
      selector:
        boolean: {}
    
    emergency_sound:
      name: "üîä Son d'urgence"
      description: "Son sp√©cial pour notifications d'incendie"
      default: "emergency"
      selector:
        text: {}
    
    vibration_pattern:
      name: "üì≥ Vibration d'urgence"
      description: "Motif de vibration d'urgence"
      default: [500, 200, 500, 200, 500, 200, 500]
      selector:
        object: {}

variables:
  repeat_interval_seconds: "{{ (repeat_interval | int) * 60 }}"
  max_notifications_count: "{{ max_notifications | int }}"
  escalation_time_seconds: "{{ (escalation_time | int) * 60 }}"
  notification_services_list: "{{ notification_services }}"
  mobile_devices_list: "{{ mobile_devices }}"
  emergency_actions_list: "{{ emergency_actions }}"
  smoke_detectors_list: "{{ smoke_detectors }}"
  co_detectors_list: "{{ co_detectors }}"
  is_test_mode: "{{ test_mode_entity and is_state(test_mode_entity, 'on') }}"
  
trigger:
  - platform: state
    entity_id: !input smoke_detectors
    to: "on"
    id: "smoke_detected"
  - platform: state
    entity_id: !input co_detectors
    to: "on"
    id: "co_detected"
  - platform: state
    entity_id: !input smoke_detectors
    to: "off"
    id: "smoke_resolved"
  - platform: state
    entity_id: !input co_detectors
    to: "off"
    id: "co_resolved"

condition:
  - condition: template
    value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"

action:
  - choose:
      # === D√âTECTION DE FUM√âE ===
      - conditions:
          - condition: trigger
            id: "smoke_detected"
        sequence:
          # Log de l'incident
          - service: logbook.log
            data:
              name: "üî• Syst√®me Incendie"
              message: "Fum√©e d√©tect√©e par {{ trigger.to_state.attributes.friendly_name }} dans {{ area_name(trigger.entity_id) or 'zone inconnue' }}"
              entity_id: "{{ trigger.entity_id }}"
          
          # Actions d'√©vacuation automatiques (sauf si mode test)
          - if:
              - condition: template
                value_template: "{{ not is_test_mode }}"
            then:
              - parallel:
                  # √âclairage d'√©vacuation maximal
                  - if:
                      - condition: template
                        value_template: "{{ 'emergency_lighting' in emergency_actions_list and emergency_lights }}"
                    then:
                      - service: light.turn_on
                        target:
                          entity_id: !input emergency_lights
                        data:
                          brightness: 255
                          color_name: red
                  
                  # Sir√®nes d'alarme
                  - if:
                      - condition: template
                        value_template: "{{ 'siren' in emergency_actions_list and emergency_sirens }}"
                    then:
                      - service: siren.turn_on
                        target:
                          entity_id: !input emergency_sirens
                  
                  # D√©verrouillage des portes
                  - if:
                      - condition: template
                        value_template: "{{ 'door_unlock' in emergency_actions_list and smart_locks }}"
                    then:
                      - service: lock.unlock
                        target:
                          entity_id: !input smart_locks
                  
                  # Ouverture des fen√™tres
                  - if:
                      - condition: template
                        value_template: "{{ 'window_open' in emergency_actions_list and smart_windows }}"
                    then:
                      - service: cover.open_cover
                        target:
                          entity_id: !input smart_windows
                  
                  # Coupure des utilities
                  - if:
                      - condition: template
                        value_template: "{{ 'utilities_shutdown' in emergency_actions_list }}"
                    then:
                      - if:
                          - condition: template
                            value_template: "{{ gas_valve }}"
                        then:
                          - service: switch.turn_off
                            target:
                              entity_id: !input gas_valve
                      - if:
                          - condition: template
                            value_template: "{{ hvac_system }}"
                        then:
                          - service: climate.turn_off
                            target:
                              entity_id: !input hvac_system
                  
                  # Annonces TTS d'√©vacuation
                  - if:
                      - condition: template
                        value_template: "{{ 'tts_evacuation' in emergency_actions_list and tts_speakers }}"
                    then:
                      - repeat:
                          count: 3
                          sequence:
                            - service: tts.speak
                              target:
                                entity_id: !input tts_speakers
                              data:
                                message: "Alerte incendie ! √âvacuez imm√©diatement le b√¢timent ! Fum√©e d√©tect√©e dans {{ area_name(trigger.entity_id) or 'la zone' }}. Sortez par la sortie la plus proche !"
                                options:
                                  volume_level: 1.0
                            - delay: "00:00:03"
                  
                  # Liaison d√©tecteurs (faire sonner tous les autres)
                  - if:
                      - condition: template
                        value_template: "{{ 'detectors_linkage' in emergency_actions_list }}"
                    then:
                      - service: script.trigger_all_smoke_alarms
                        continue_on_error: true
                  
                  # Enregistrement cam√©ras
                  - if:
                      - condition: template
                        value_template: "{{ 'camera_record' in emergency_actions_list and security_cameras }}"
                    then:
                      - service: camera.record
                        target:
                          entity_id: !input security_cameras
                        data:
                          duration: 300
                          filename: "/config/recordings/emergency_{{ now().strftime('%Y%m%d_%H%M%S') }}.mp4"
          
          # Notifications d'urgence imm√©diates
          - parallel:
              # Notification persistante critique
              - if:
                  - condition: template
                    value_template: "{{ 'persistent' in notification_services_list }}"
                then:
                  - service: persistent_notification.create
                    data:
                      title: !input fire_alert_title
                      message: !input fire_alert_message
                      notification_id: "fire_emergency_{{ trigger.entity_id.split('.')[1] }}"
              
              # Notifications mobiles critiques
              - if:
                  - condition: template
                    value_template: "{{ 'mobile_app' in notification_services_list and mobile_devices_list }}"
                then:
                  - repeat:
                      for_each: !input mobile_devices
                      sequence:
                        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                          data:
                            title: !input fire_alert_title
                            message: !input fire_alert_message
                            data:
                              tag: "fire_emergency_{{ trigger.entity_id.split('.')[1] }}"
                              priority: "high"
                              ttl: 0
                              persistent: true
                              notification_icon: "mdi:fire-alert"
                              color: "#FF0000"
                              sound: !input emergency_sound
                              vibrationPattern: !input vibration_pattern
                              actions:
                                - action: "EVACUATED_SAFE"
                                  title: "‚úÖ √âvacu√© en s√©curit√©"
                                - action: "CALL_EMERGENCY"
                                  title: "üìû Appeler pompiers"
                                - action: "FALSE_ALARM"
                                  title: "üö´ Fausse alarme"
              
              # Notifications email d'urgence
              - if:
                  - condition: template
                    value_template: "{{ 'email' in notification_services_list }}"
                then:
                  - service: notify.email
                    data:
                      subject: !input fire_alert_title
                      message: !input fire_alert_message
                      data:
                        html: |
                          <html>
                          <body style="background-color: #ffebee; padding: 20px; font-family: Arial;">
                          <div style="background-color: #d32f2f; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                          <h1>üö® {{ fire_alert_title }}</h1>
                          </div>
                          <div style="background-color: white; padding: 20px; border-radius: 5px;">
                          <pre>{{ fire_alert_message }}</pre>
                          </div>
                          <p style="color: #d32f2f; font-weight: bold;">Ce message a √©t√© envoy√© par votre syst√®me domotique Home Assistant</p>
                          </body>
                          </html>
              
              # Autres services de notification
              - repeat:
                  for_each: "{{ notification_services_list }}"
                  sequence:
                    - if:
                        - condition: template
                          value_template: "{{ repeat.item not in ['mobile_app', 'persistent', 'email'] }}"
                      then:
                        - service: "notify.{{ repeat.item }}"
                          data:
                            title: !input fire_alert_title
                            message: !input fire_alert_message
                          continue_on_error: true
          
          # Boucle de notifications r√©p√©t√©es d'urgence
          - repeat:
              while:
                - condition: state
                  entity_id: "{{ trigger.entity_id }}"
                  state: "on"
                - condition: template
                  value_template: >
                    {% if max_notifications_count > 0 %}
                      {{ repeat.index <= max_notifications_count }}
                    {% else %}
                      true
                    {% endif %}
              sequence:
                # D√©lai avec escalade si activ√©e
                - delay: >
                    {% if escalation_enabled and (now() - trigger.to_state.last_changed).total_seconds() > escalation_time_seconds %}
                      {{ [repeat_interval_seconds // 3, 30] | max }}
                    {% else %}
                      {{ repeat_interval_seconds }}
                    {% endif %}
                
                # V√©rifier si toujours en alarme
                - condition: state
                  entity_id: "{{ trigger.entity_id }}"
                  state: "on"
                
                # Envoyer notifications r√©p√©t√©es d'urgence
                - parallel:
                    # Notification persistante (mise √† jour)
                    - if:
                        - condition: template
                          value_template: "{{ 'persistent' in notification_services_list }}"
                      then:
                        - service: persistent_notification.create
                          data:
                            title: "{{ fire_alert_title }} - RAPPEL URGENT #{{ repeat.index }}"
                            message: !input repeat_message
                            notification_id: "fire_emergency_{{ trigger.entity_id.split('.')[1] }}"
                    
                    # Notifications mobiles r√©p√©t√©es
                    - if:
                        - condition: template
                          value_template: "{{ 'mobile_app' in notification_services_list and mobile_devices_list }}"
                      then:
                        - repeat:
                            for_each: !input mobile_devices
                            sequence:
                              - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                data:
                                  title: "{{ fire_alert_title }} - RAPPEL #{{ repeat.index }}"
                                  message: !input repeat_message
                                  data:
                                    tag: "fire_emergency_{{ trigger.entity_id.split('.')[1] }}"
                                    priority: "high"
                                    persistent: true
                                    notification_icon: "mdi:fire-alert"
                                    color: "#FF6600"
                                    sound: !input emergency_sound
                
                # Annonce TTS p√©riodique d'√©vacuation
                - if:
                    - condition: template
                      value_template: "{{ 'tts_evacuation' in emergency_actions_list and tts_speakers and repeat.index % 3 == 0 }}"
                  then:
                    - service: tts.speak
                      target:
                        entity_id: !input tts_speakers
                      data:
                        message: "Rappel d'√©vacuation ! L'alarme incendie est toujours active. Si vous √™tes encore dans le b√¢timent, sortez imm√©diatement !"
      
      # === D√âTECTION MONOXYDE DE CARBONE ===
      - conditions:
          - condition: trigger
            id: "co_detected"
        sequence:
          # Actions similaires pour CO avec message sp√©cifique
          - service: logbook.log
            data:
              name: "‚ò†Ô∏è Syst√®me CO"
              message: "Monoxyde de carbone d√©tect√© par {{ trigger.to_state.attributes.friendly_name }}"
              entity_id: "{{ trigger.entity_id }}"
          
          # Actions d'urgence CO (ouverture maximale pour a√©ration)
          - parallel:
              - if:
                  - condition: template
                    value_template: "{{ smart_windows }}"
                then:
                  - service: cover.open_cover
                    target:
                      entity_id: !input smart_windows
              
              - if:
                  - condition: template
                    value_template: "{{ emergency_sirens }}"
                then:
                  - service: siren.turn_on
                    target:
                      entity_id: !input emergency_sirens
          
          # Notifications CO imm√©diates
          - parallel:
              - if:
                  - condition: template
                    value_template: "{{ 'mobile_app' in notification_services_list and mobile_devices_list }}"
                then:
                  - repeat:
                      for_each: !input mobile_devices
                      sequence:
                        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                          data:
                            title: "‚ò†Ô∏è ALERTE MONOXYDE DE CARBONE"
                            message: !input co_alert_message
                            data:
                              priority: "high"
                              ttl: 0
                              persistent: true
                              notification_icon: "mdi:skull"
                              color: "#8B0000"
                              sound: !input emergency_sound
      
      # === R√âSOLUTION D'INCIDENT ===
      - conditions:
          - or:
              - condition: trigger
                id: "smoke_resolved"
              - condition: trigger
                id: "co_resolved"
        sequence:
          # Arr√™t des actions d'urgence
          - parallel:
              - if:
                  - condition: template
                    value_template: "{{ emergency_sirens }}"
                then:
                  - service: siren.turn_off
                    target:
                      entity_id: !input emergency_sirens
              
              - service: persistent_notification.dismiss
                data:
                  notification_id: "fire_emergency_{{ trigger.entity_id.split('.')[1] }}"
                continue_on_error: true
          
          # Notification de r√©solution
          - parallel:
              - service: persistent_notification.create
                data:
                  title: "‚úÖ Incident R√©solu"
                  message: !input resolved_message
                  notification_id: "fire_resolved_{{ trigger.entity_id.split('.')[1] }}"
              
              - if:
                  - condition: template
                    value_template: "{{ 'mobile_app' in notification_services_list and mobile_devices_list }}"
                then:
                  - repeat:
                      for_each: !input mobile_devices
                      sequence:
                        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                          data:
                            title: "‚úÖ Alerte Incendie R√©solue"
                            message: !input resolved_message
                            data:
                              tag: "fire_emergency_{{ trigger.entity_id.split('.')[1] }}"
                              notification_icon: "mdi:fire-off"
                              color: "#4CAF50"

mode: parallel
max_exceeded: silent
